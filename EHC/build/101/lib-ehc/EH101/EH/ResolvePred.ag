SEM Expr
  | Sel         loc         .   prUid               =   mkPrIdCHR @lUniq2
                            .   prOccL              =   [rngLift @range mkPredOccRng (Pred_Lacks @knRowTy (Label_Lab @lbl)) @prUid @lhs.predScope]
                loc         .   lUniq2              :   UNIQUEREF gUniq

SEM RecExpr
  | Ext         loc         .   prUid               =   mkPrIdCHR @lUniq3
                loc         .   lUniq3              :   UNIQUEREF gUniq
  | Upd         loc         .   prUid               =   mkPrIdCHR @lUniq4
                loc         .   lUniq4              :   UNIQUEREF gUniq
  | Ext Upd     loc         .   prOccL              =   [rngLift @range mkPredOccRng (Pred_Lacks @knRowTy (Label_Lab @nm)) @prUid @lhs.predScope]

SEM RecPatExpr
  | Ext         loc         .   prUid               =   mkPrIdCHR @lUniq3
                            .   prOccL              =   [rngLift @range mkPredOccRng (Pred_Lacks @rowTy (Label_Lab @nm)) @prUid @lhs.predScope]
                loc         .   lUniq3              :   UNIQUEREF gUniq

SEM Expr
  | App AppImpred
                loc         .   imPrvOcc            =   mkImplsProveOcc @lUniq3 @lhs.predScope
                            .   (implsPrvOccTl,prvOccTlVarMp)
                                                    =   varmpTailAddOcc @imPrvOcc @implsTl
                loc         .   lUniq3              :   UNIQUEREF gUniq

SEM Expr
  | AppTop Rec Let
                loc         .   imSubsTy            =   foVarMp @foKnRes `varUpd` @imTy
  | Lam         loc         .   imSubsTy            =   foVarMp @fo_fitF_ `varUpd` @imTy

SEM Expr
  | AppTop Rec Lam Let
                loc         .   (knPrL,knImplsTl)   =   implsPredsTail @predScope $ tyImpls @imSubsTy
                            .   implsIsEmpty        =   let (knpr,_)
                                                              = implsPredsTailWithLkup (varmpImplsLookupCyc2 @lhs.tyVarMp) initPredScope
                                                              $ tyImplsWithLkup (varmpTyLookupCyc2 @lhs.tyVarMp) @lhs.knTy
                                                        in  null knpr

SEM Expr
  | LamImpl     loc         .   knPr                =   tyPred $ (@body.tyVarMp `varUpd`) $ @knArgImpl
                            .   knPrUid             =   mkPrIdCHR @lUniq
                            .   knPrL               =   [mkPredOcc @knPr @knPrUid @predScope]

ATTR NTCode [ | cSubst: CSubst | ]

SEM AGItf
  | AGItf       loc         .   cSubst              =   emptyCSubst

SEM Decl
  | Instance    loc         .   cSubstDecls         =   cSubstApp @lhs.cSubst
                                                        $ evidKeyBindMpToCSubst @chrEvidBindMp
                decls       .   cSubst              =   @cSubstDecls
                lhs         .   cSubst              =   cSubstApp @decls.cSubst @cSubstInst

SEM Expr
  | Let         decls       .   cSubst              =   ehcOptTrace @lhs.opts "Expr.Let.decls.cSubst"
                                                        $ cSubstApp @lhs.cSubst
                                                        $ cSubstApp @prvArgCSubst
                                                        $ cSubstApp (acoreCSubstFromVarMpImpls @tmpoTyVarMp)
                                                        $ evidKeyBindMpToCSubst @chrSolveEvidBindMp

SEM Expr
  | AppTop Rec Lam Let
                loc         .   impls2KnHd          =   tyImpls @imSubsTy
                            .   impls2KnTl          =   @lhs.finTyVarMp `varUpd` @knImplsTl
                            .   poiLKnTl            =   implsPrIds @impls2KnTl
                            .   poiL                =   implsPrIds @impls2KnHd ++ @poiLKnTl

SEM Expr
  | LamImpl     loc         .   poiL                =   [@knPrUid]

SEM Expr
  | AppTop Rec Lam
    LamImpl
                loc         .   poiBindL            =   @chrAssumeBindL ++ @chrScopeBindL
  | Let         loc         .   poiBindL            =   @chrAssumeBindL

