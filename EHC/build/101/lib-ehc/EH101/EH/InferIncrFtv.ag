ATTR AllNT [ valTyGlobFreeTvarS: TyVarIdS | | ]

SEM AGItf
  | AGItf       expr        .   valTyGlobFreeTvarS  =   Set.empty

SEM Expr
  | Let         loc         .   valTyUpdFreeTvarS   =   setSubst @tyVarMpDeclsL0 @lhs.valTyGlobFreeTvarS
                decls       .   valTyGlobFreeTvarS  =   varFreeSet @valGam_l_ `Set.union` @lhs.valTyGlobFreeTvarS
                body        .   valTyGlobFreeTvarS  =   ehcOptTrace @lhs.opts "Expr.Let.body.valTyGlobFreeTvarS" $
                                                        varFreeSet @quValGam_ex_subst `Set.union` @valTyUpdFreeTvarS
  | Lam         body        .   valTyGlobFreeTvarS  =   varFreeSet (gamTop @arg.valGam) `Set.union` @lhs.valTyGlobFreeTvarS
  | TypeAs      loc         .   valTyUpdFreeTvarS   =   setSubst @lhs.tyVarMp @lhs.valTyGlobFreeTvarS

SEM CaseAlt
  | Pat         expr        .   valTyGlobFreeTvarS  =   varFreeSet (gamTop @patExpr.valGam) `Set.union` @lhs.valTyGlobFreeTvarS

SEM Decl
  | Instance
                decls       .   valTyGlobFreeTvarS  =   varFreeSet (gamTop @decls.patValGam) `Set.union` @lhs.valTyGlobFreeTvarS

ATTR AllNT [ tyTyGlobFreeTvarS: TyVarIdS | | ]

SEM AGItf
  | AGItf       expr        .   tyTyGlobFreeTvarS   =   Set.empty

SEM Expr
  | Let         loc         .   tyTyUpdFreeTvarS    =   setSubst @tyVarMpDeclsL0 @lhs.tyTyGlobFreeTvarS
                decls       .   tyTyGlobFreeTvarS   =   varFreeSet @tyGam_l_ `Set.union` @lhs.tyTyGlobFreeTvarS
                loc         .   tyTyGlobFreeTvarSbody
                                                    =   ehcOptTrace @lhs.opts "Expr.Let.loc.tyTyGlobFreeTvarSbody" $
                                                        varFreeSet @lQuTyGam `Set.union` @tyTyUpdFreeTvarS
                body        .   tyTyGlobFreeTvarS   =   @tyTyGlobFreeTvarSbody
  | Lam         body        .   tyTyGlobFreeTvarS   =   varFreeSet (gamTop @arg.tyGam) `Set.union` @lhs.tyTyGlobFreeTvarS
  | TypeAs      loc         .   tyTyUpdFreeTvarS    =   setSubst @lhs.tyVarMp @lhs.tyTyGlobFreeTvarS
                expr        .   tyTyGlobFreeTvarS   =   @tyVarWildS `Set.union` @lhs.tyTyGlobFreeTvarS

SEM CaseAlt
  | Pat         expr        .   tyTyGlobFreeTvarS   =   varFreeSet (gamTop @patExpr.tyGam) `Set.union` @lhs.tyTyGlobFreeTvarS

SEM Decl
  | Class Instance
                decls       .   tyTyGlobFreeTvarS   =   varFreeSet (gamTop @tyPrExpr.tyGam) `Set.union` @lhs.tyTyGlobFreeTvarS

ATTR AllNT [ tyTyTySigFreeTvarS: TyVarIdS | | ]     -- specifically for Decl_TySig, to avoid dependence on pattern intro'd stuff

SEM AGItf
  | AGItf       expr        .   tyTyTySigFreeTvarS  =   Set.empty

SEM Expr
  | Let         decls       .   tyTyTySigFreeTvarS  =   @lhs.tyTyTySigFreeTvarS
                body        .   tyTyTySigFreeTvarS  =   ehcOptTrace @lhs.opts "Expr.Let.body.tyTyTySigFreeTvarS" $
                                                        varFreeSet @lQuTyGam `Set.union` @lhs.tyTyTySigFreeTvarS

SEM Decl
  | TySig       loc         .   tyTyUpdFreeTvarS    =   @lhs.tyTyTySigFreeTvarS
  | Class Instance
                decls       .   tyTyTySigFreeTvarS  =   varFreeSet (gamTop @tyPrExpr.tyGam) `Set.union` @lhs.tyTyTySigFreeTvarS

ATTR AllNT [ tyKiGlobFreeTvarS: TyVarIdS | | ]

SEM AGItf
  | AGItf       expr        .   tyKiGlobFreeTvarS   =   Set.empty

SEM Expr
  | Let         loc         .   tyKiUpdFreeTvarS    =   setSubst @decls.kiVarMp @lhs.tyKiGlobFreeTvarS
                decls       .   tyKiGlobFreeTvarS   =   varFreeSet @tyKiGam_l_ `Set.union` @lhs.tyKiGlobFreeTvarS
                body        .   tyKiGlobFreeTvarS   =   ehcOptTrace @lhs.opts "Expr.Let.body.tyKiGlobFreeTvarS" $
                                                        varFreeSet @lQuTyKiGam_ex_subst `Set.union` setSubst @bodyTyKiVarMp2 @tyKiUpdFreeTvarS
  | Lam         body        .   tyKiGlobFreeTvarS   =   varFreeSet (@arg.kiVarMp `varUpd` gamTop @arg.tyKiGam) `Set.union` @lhs.tyKiGlobFreeTvarS
--  | TypeAs      loc         .   tyKiUpdFreeTvarS    =   setSubst @lhs.kiVarMp @lhs.tyKiGlobFreeTvarS

SEM CaseAlt
  | Pat         expr        .   tyKiGlobFreeTvarS   =   varFreeSet (@patExpr.kiVarMp `varUpd` gamTop @patExpr.tyKiGam) `Set.union` @lhs.tyKiGlobFreeTvarS

SEM Decl
  | Instance
                decls       .   tyKiGlobFreeTvarS   =   varFreeSet ({- @decls.kiVarMp `varUpd` -} gamTop @decls.patTyKiGam) `Set.union` @lhs.tyKiGlobFreeTvarS

